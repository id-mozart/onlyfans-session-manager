name: Build macOS DMG

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'
      universal:
        description: 'Build universal binary (Intel + Apple Silicon)'
        required: false
        type: boolean
        default: true

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: desktop
        run: npm install
      
      - name: Update version
        if: ${{ github.event.inputs.version != '' }}
        working-directory: desktop
        run: npm version ${{ github.event.inputs.version }} --no-git-tag-version --allow-same-version
      
      - name: Build DMG (Universal)
        if: ${{ github.event.inputs.universal == 'true' }}
        working-directory: desktop
        run: npx electron-builder --mac --universal --publish=never
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build DMG (Current Architecture)
        if: ${{ github.event.inputs.universal != 'true' }}
        working-directory: desktop
        run: npx electron-builder --mac --publish=never
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: List build output
        working-directory: desktop
        run: |
          echo "Contents of dist folder:"
          ls -lah dist/ || echo "No dist folder found"
          echo ""
          echo "DMG files:"
          find dist -name "*.dmg" -type f 2>/dev/null || echo "No DMG files found"
          echo ""
          echo "ZIP files:"
          find dist -name "*.zip" -type f 2>/dev/null || echo "No ZIP files found"
      
      - name: Get DMG filename
        id: dmg-info
        working-directory: desktop
        run: |
          if [ -d "dist" ]; then
            cd dist
            DMG_FILE=$(find . -name "*.dmg" -type f | head -n 1 | sed 's|^\./||')
            if [ -n "$DMG_FILE" ]; then
              echo "filename=$DMG_FILE" >> $GITHUB_OUTPUT
              echo "Found DMG: $DMG_FILE"
            else
              echo "No DMG file found"
              echo "filename=" >> $GITHUB_OUTPUT
            fi
          else
            echo "No dist directory found"
            echo "filename=" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload DMG artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-${{ github.event.inputs.version || '1.0.0' }}
          path: desktop/dist/*.dmg
          if-no-files-found: warn
          retention-days: 90
      
      - name: Upload ZIP artifact (fallback)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-zip-${{ github.event.inputs.version || '1.0.0' }}
          path: desktop/dist/*.zip
          if-no-files-found: ignore
          retention-days: 90
      
      - name: Build Summary
        if: always()
        run: |
          echo "# ðŸŽ‰ Build Completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.event.inputs.version || '1.0.0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Universal Build:** ${{ github.event.inputs.universal }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.dmg-info.outputs.filename }}" ]; then
            echo "- **DMG File:** \`${{ steps.dmg-info.outputs.filename }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âœ… Success!" >> $GITHUB_STEP_SUMMARY
            echo "DMG file created successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âš ï¸ Warning" >> $GITHUB_STEP_SUMMARY
            echo "DMG file not created. Check ZIP artifact as fallback." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "Scroll up to the **Artifacts** section and download:" >> $GITHUB_STEP_SUMMARY
          echo "- \`macos-dmg-${{ github.event.inputs.version || '1.0.0' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Installation" >> $GITHUB_STEP_SUMMARY
          echo "1. Download and extract the artifact ZIP" >> $GITHUB_STEP_SUMMARY
          echo "2. Double-click the .dmg file" >> $GITHUB_STEP_SUMMARY
          echo "3. Drag the app to Applications folder" >> $GITHUB_STEP_SUMMARY
          echo "4. If macOS blocks the app, go to System Settings â†’ Privacy & Security â†’ Click \"Open Anyway\"" >> $GITHUB_STEP_SUMMARY
