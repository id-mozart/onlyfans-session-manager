name: Build macOS DMG

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'
      universal:
        description: 'Build universal binary (Intel + Apple Silicon)'
        required: false
        type: boolean
        default: true

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: desktop
        run: npm install
      
      - name: Update version
        if: ${{ github.event.inputs.version != '' }}
        working-directory: desktop
        run: npm version ${{ github.event.inputs.version }} --no-git-tag-version --allow-same-version
      
      - name: Build DMG (Universal)
        if: ${{ github.event.inputs.universal == 'true' }}
        working-directory: desktop
        run: npm run build:mac:universal
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build DMG (Current Architecture)
        if: ${{ github.event.inputs.universal != 'true' }}
        working-directory: desktop
        run: npm run build:mac
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get DMG filename
        id: dmg-info
        working-directory: desktop/dist
        run: |
          DMG_FILE=$(ls *.dmg | head -n 1)
          echo "filename=$DMG_FILE" >> $GITHUB_OUTPUT
          echo "Found DMG: $DMG_FILE"
      
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: desktop/dist/*.dmg
          retention-days: 30
      
      - name: Create Release
        if: ${{ github.event.inputs.version != '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Release v${{ github.event.inputs.version }}
          body: |
            ## OnlyFans Session Manager v${{ github.event.inputs.version }}
            
            ### ðŸ“¦ Downloads
            - **macOS**: Download the .dmg file below
            
            ### ðŸš€ Installation
            1. Download the .dmg file
            2. Double-click to open
            3. Drag the app to Applications folder
            4. Launch from Launchpad or Applications
            
            ### âš ï¸ First Launch
            If macOS blocks the app:
            - Go to System Settings â†’ Privacy & Security
            - Click "Open Anyway"
            
            Or run in Terminal:
            ```bash
            xattr -cr "/Applications/OnlyFans Session Manager.app"
            ```
          files: desktop/dist/*.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build Summary
        run: |
          echo "### âœ… Build Completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**DMG File:** ${{ steps.dmg-info.outputs.filename }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version || '1.0.0' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Universal:** ${{ github.event.inputs.universal }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifact from the Actions tab or the Releases page." >> $GITHUB_STEP_SUMMARY
